<?php

namespace AkademiaBundle\Repository;

/**
 * ComplejoDeportivoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ComplejoDeportivoRepository extends \Doctrine\ORM\EntityRepository
{


	public function complejoDeportivoExport(){
       $query = "SELECT distinct ubiDpto.ubidpto idDepartamento ,ede.ede_codigo id, ede.ede_nombre nombre
    				FROM ACADEMIA.inscribete AS ins
    				inner join (SELECT m.inscribete_id as mov_ins_id, MAX(m.id) mov_id FROM ACADEMIA.movimientos m
				    GROUP BY m.inscribete_id) ids ON ins.id = ids.mov_ins_id
				    inner join ACADEMIA.movimientos mov on mov.id = ids.mov_id 
				    inner join ACADEMIA.participante par on par.id = ins.participante_id
				    inner join ACADEMIA.apoderado apod on apod.id = par.apoderado_id
				    inner join grpersona grApod on grApod.percodigo = apod.percodigo

					inner join ACADEMIA.horario hor on hor.id=ins.horario_id
					inner join CATASTRO.edificacionDisciplina edi on edi.edi_codigo = hor.edi_codigo
				    inner join CATASTRO.edificacionesdeportivas ede on ede.ede_codigo = edi.ede_codigo

				    inner join grubigeo ubi on ubi.ubicodigo = ede.ubicodigo
					inner join grubigeo ubiDpto on ubiDpto.ubidpto = ubi.ubidpto

					WHERE ubiDpto.ubidistrito=0 AND ubiDpto.ubiprovincia=0 AND ubiDpto.ubidpto!=0;";
				           $stmt = $this->getEntityManager()->getConnection()->prepare($query);
           $stmt->execute();
           $complejosDeportivos = $stmt->fetchAll();
           return $complejosDeportivos;		
	}



	public function complejoDeportivoExportFind($id){
       $query = "SELECT distinct ubiDpto.ubidpto idDepartamento ,ede.ede_codigo id, ede.ede_nombre nombre
    				FROM ACADEMIA.inscribete AS ins
    				inner join (SELECT m.inscribete_id as mov_ins_id, MAX(m.id) mov_id FROM ACADEMIA.movimientos m
				    GROUP BY m.inscribete_id) ids ON ins.id = ids.mov_ins_id
				    inner join ACADEMIA.movimientos mov on mov.id = ids.mov_id 
				    inner join ACADEMIA.participante par on par.id = ins.participante_id
				    inner join ACADEMIA.apoderado apod on apod.id = par.apoderado_id
				    inner join grpersona grApod on grApod.percodigo = apod.percodigo

					inner join ACADEMIA.horario hor on hor.id=ins.horario_id
					inner join CATASTRO.edificacionDisciplina edi on edi.edi_codigo = hor.edi_codigo
				    inner join CATASTRO.edificacionesdeportivas ede on ede.ede_codigo = edi.ede_codigo

				    inner join grubigeo ubi on ubi.ubicodigo = ede.ubicodigo
					inner join grubigeo ubiDpto on ubiDpto.ubidpto = ubi.ubidpto
				    
					WHERE ubiDpto.ubidistrito=0 AND ubiDpto.ubiprovincia=0 AND ubiDpto.ubidpto!=0 AND ede.ede_codigo='$id' ";
           $stmt = $this->getEntityManager()->getConnection()->prepare($query);
           $stmt->execute();
           $complejosDeportivos = $stmt->fetchAll();
           return $complejosDeportivos;		
	}



	public function complejoDeportivoExportFind2($id){
       $query = " SELECT distinct ubiDpto.ubidpto idDepartamento, ede.ede_codigo id , ede.ede_nombre nombre
        FROM 
            grubigeo ubiDpto 

        inner join CATASTRO.edificacionesdeportivas ede on ede.ubicodigo = ubiDpto.ubicodigo
        WHERE  ede.ede_codigo='$id';";

           $stmt = $this->getEntityManager()->getConnection()->prepare($query);
           $stmt->execute();
           $complejosDeportivos = $stmt->fetchAll();
           return $complejosDeportivos;		
	}

	public function getComplejosDeportivos()
	{

       $query = "SELECT ede_codigo as id, ede_nombre as nombre ,ubicodigo , ede_direccion as direccion, ede_estado as estado, ede_discapacitado as discapacitado from CATASTRO.edificacionesdeportivas;";
        $stmt = $this->getEntityManager()->getConnection()->prepare($query);
        $stmt->execute();
        $complejosDeportivos = $stmt->fetchAll();

        return $complejosDeportivos;        		
	}

	public function getComplejosDeportivosDiscapacitados()
	{
		$query = "SELECT ede_codigo as id, ede_nombre as nombre ,ubicodigo, ede_direccion as direccion, ede_estado as estado,ede_discapacitado as discapacidad from CATASTRO.edificacionesdeportivas where ede_discapacitado='1'";

		$stmt = $this->getEntityManager()->getConnection()->prepare($query);
		$stmt->execute();
		$complejosDeportivos = $stmt->fetchAll();

		return $complejosDeportivos;
	}

	public function complejosDeportivosFlagAll($flagDis,$edadBeneficiario)
	{
		$query = "SELECT distinct edde.ede_codigo as id, edde.ede_nombre as nombre ,edde.ubicodigo ,edde.ede_direccion as direccion, edde.ede_estado as estado,edde.ede_discapacitado as discapacitado from ACADEMIA.horario AS hor , CATASTRO.edificacionDisciplina as eddis, CATASTRO.edificacionesdeportivas AS edde where hor.discapacitados='$flagDis' and hor.estado=1 and hor.edi_codigo=eddis.edi_codigo and edde.ede_codigo=eddis.ede_codigo and hor.vacantes<>0 and hor.convocatoria=1 and '$edadBeneficiario'<=hor.edadMaxima and '$edadBeneficiario'>=hor.edadMinima;";

		$stmt = $this->getEntityManager()->getConnection()->prepare($query);
		$stmt->execute();
		$complejosDeportivos = $stmt->fetchAll();
		return $complejosDeportivos;
	}

	public function complejosDeportivosPromotor($flagDis)
	{
		$query = "SELECT distinct edde.ede_codigo as id, edde.ede_nombre as nombre ,edde.ubicodigo ,edde.ede_direccion as direccion, edde.ede_estado as estado,edde.ede_discapacitado as discapacitado from ACADEMIA.horario AS hor , CATASTRO.edificacionDisciplina as eddis, CATASTRO.edificacionesdeportivas AS edde where hor.discapacitados='$flagDis' and hor.estado=1 and hor.edi_codigo=eddis.edi_codigo and edde.ede_codigo=eddis.ede_codigo and hor.vacantes<>0";

		$stmt = $this->getEntityManager()->getConnection()->prepare($query);
		$stmt->execute();
		$complejosDeportivos = $stmt->fetchAll();
		return $complejosDeportivos;
	}


	
	public function getEditarDiscapacitado($idComplejo, $usuario){
	
		$query = "UPDATE catastro.edificacionesdeportivas set ede_discapacitado = 1, ede_usumodi = $usuario, ede_fechamodi = getDate() where ede_codigo= $idComplejo";
        $stmt = $this->getEntityManager()->getConnection()->prepare($query);
        $stmt->execute();
	
	}


	public function nombreComplejo($idComplejo){
		$query = "SELECT b.ede_nombre as nombreComplejo from academia.usuario a inner join catastro.edificacionesdeportivas b on a.id_complejo = b.ede_codigo where a.id_complejo = $idComplejo";
		
		$stmt = $this->getEntityManager()->getConnection()->prepare($query);
		$stmt->execute();
		$nombre = $stmt->fetchAll();

		return $nombre;
	}
}
